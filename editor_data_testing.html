<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Data Editor Pro ‚Äî Editor Masivo de Datos</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- SheetJS para soporte Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
      :root {
        --bg: #0d1220;
        --card: #111a2b;
        --card2: #0f172a;
        --text: #f0f4ff;
        --muted: #a5b4ce;
        --border: #2a3957;
        --accent: #7cb2ff;
        --accent-hover: #5a9ae8;
        --success: #4ade80;
        --warning: #fbbf24;
        --error: #f87171;
        --ink: #081629;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 15px/1.6 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Ubuntu, sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      .header {
        margin-bottom: 24px;
      }
      .header h1 {
        font-size: 32px;
        font-weight: 800;
        margin: 0 0 8px;
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--success) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .header .subtitle {
        color: var(--muted);
        font-size: 14px;
      }

      /* Status Bar */
      .status-bar {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .status-bar .icon {
        font-size: 20px;
      }
      .status-bar.info {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
      }
      .status-bar.success {
        border-color: var(--success);
        background: linear-gradient(135deg, #065f46 0%, #1e293b 100%);
      }
      .status-bar.warning {
        border-color: var(--warning);
        background: linear-gradient(135deg, #78350f 0%, #1e293b 100%);
      }
      .status-bar.error {
        border-color: var(--error);
        background: linear-gradient(135deg, #7f1d1d 0%, #1e293b 100%);
      }

      /* Stepper */
      .stepper {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      .step {
        flex: 1;
        min-width: 150px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .step:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
      }
      .step.active {
        border-color: var(--accent);
        background: linear-gradient(135deg, #1e3a8a 0%, var(--card) 100%);
        box-shadow: 0 4px 12px rgba(124, 178, 255, 0.2);
      }
      .step.completed {
        border-color: var(--success);
        background: linear-gradient(135deg, #065f46 0%, var(--card) 100%);
      }
      .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--border);
        display: grid;
        place-items: center;
        font-weight: 700;
        font-size: 14px;
      }
      .step.active .step-number {
        background: var(--accent);
        color: var(--ink);
      }
      .step.completed .step-number {
        background: var(--success);
        color: var(--ink);
      }
      .step-label {
        font-weight: 600;
        font-size: 14px;
      }

      /* Card */
      .card {
        background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      }

      .card h2 {
        font-size: 22px;
        font-weight: 700;
        margin: 0 0 8px;
        color: var(--accent);
      }
      .card .description {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 20px;
        line-height: 1.5;
      }

      /* Subsection styling */
      .subsection {
        background: rgba(124, 178, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .subsection h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 16px;
        color: var(--success);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 10px 14px;
        background: #0a1628;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        transition: all 0.2s;
      }
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(124, 178, 255, 0.1);
      }
      .form-input[type="file"] {
        padding: 8px;
        cursor: pointer;
      }

      /* Indicador visual para select de valores √∫nicos */
      .form-select[data-field="value"] {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237cb2ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
      }

      /* Indicador de que hay valores √∫nicos disponibles */
      .form-label .unique-indicator {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Grid Layout */
      .grid {
        display: grid;
        gap: 16px;
      }
      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      .grid-4 {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .btn-primary {
        background: var(--accent);
        color: var(--ink);
      }
      .btn-primary:hover:not(:disabled) {
        background: var(--accent-hover);
      }

      .btn-success {
        background: var(--success);
        color: var(--ink);
      }

      .btn-warning {
        background: var(--warning);
        color: var(--ink);
      }

      .btn-danger {
        background: var(--error);
        color: white;
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .btn-ghost:hover:not(:disabled) {
        border-color: var(--accent);
        background: rgba(124, 178, 255, 0.1);
      }

      .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      /* Table */
      .table-container {
        overflow: auto;
        max-height: 600px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--card2);
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .data-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--card);
      }
      .data-table th {
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
        user-select: none;
      }
      .data-table th.sortable {
        cursor: pointer;
      }
      .data-table th.sortable:hover {
        background: rgba(124, 178, 255, 0.1);
      }
      .data-table td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }
      .data-table tbody tr:hover {
        background: rgba(124, 178, 255, 0.05);
      }
      .data-table tbody tr.filtered-out {
        display: none;
      }
      .data-table tbody tr.modified {
        background: rgba(74, 222, 128, 0.1);
      }

      /* Pills/Badges */
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        background: var(--border);
        color: var(--text);
      }
      .pill.info {
        background: #1e3a8a;
        color: #93c5fd;
      }
      .pill.success {
        background: #065f46;
        color: #86efac;
      }
      .pill.warning {
        background: #78350f;
        color: #fcd34d;
      }
      .pill.error {
        background: #7f1d1d;
        color: #fca5a5;
      }

      /* Filter Section */
      .filter-item {
        background: rgba(124, 178, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
      }
      .filter-item .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .filter-item .filter-title {
        font-weight: 600;
        font-size: 14px;
      }

      /* Editor Section */
      .editor-section {
        background: rgba(74, 222, 128, 0.05);
        border: 1px solid var(--success);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
      }

      /* Hidden */
      .hidden {
        display: none !important;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--card2);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--accent);
      }

      /* Stats */
      .stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 16px;
      }
      .stat-card {
        flex: 1;
        min-width: 150px;
        padding: 16px;
        background: rgba(124, 178, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--accent);
      }
      .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }

      /* File List */
      .file-list {
        margin-top: 12px;
      }
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: rgba(124, 178, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .file-name {
        font-size: 13px;
        font-weight: 500;
      }
      .file-meta {
        font-size: 11px;
        color: var(--muted);
      }
      /* Warning Box para columnas inconsistentes */
      .warning-box {
        background: linear-gradient(135deg, #78350f 0%, #1e293b 100%);
        border: 2px solid var(--warning);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .warning-box h3 {
        color: var(--warning);
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .warning-box p {
        color: var(--text);
        font-size: 14px;
        line-height: 1.6;
        margin: 0 0 16px;
      }

      .file-columns-list {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
      }

      .file-columns-item {
        padding: 10px;
        margin-bottom: 8px;
        background: rgba(124, 178, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 6px;
      }

      .file-columns-item .file-name-header {
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 8px;
        font-size: 13px;
      }

      .file-columns-item .columns-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .column-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text);
      }

      .column-tag.missing {
        background: rgba(248, 113, 113, 0.2);
        border-color: var(--error);
        color: var(--error);
      }

      .column-tag.extra {
        background: rgba(251, 191, 36, 0.2);
        border-color: var(--warning);
        color: var(--warning);
      }

      /* Change Log Panel */
      .change-log-panel {
        background: linear-gradient(135deg, #065f46 0%, #1e293b 100%);
        border: 2px solid var(--success);
        border-radius: 12px;
        padding: 20px;
        margin-top: 24px;
        margin-bottom: 24px;
      }

      .change-log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        margin-bottom: 16px;
      }

      .change-log-header:hover {
        opacity: 0.9;
      }

      .change-log-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
        font-weight: 700;
        color: var(--success);
      }

      .change-log-toggle {
        font-size: 24px;
        transition: transform 0.3s ease;
      }

      .change-log-toggle.collapsed {
        transform: rotate(-90deg);
      }

      .change-log-content {
        max-height: 500px;
        overflow-y: auto;
        transition: all 0.3s ease;
      }

      .change-log-content.collapsed {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
      }

      .change-log-empty {
        text-align: center;
        padding: 30px;
        color: var(--muted);
        font-size: 14px;
      }

      .change-log-item {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
      }

      .change-log-item:hover {
        background: rgba(0, 0, 0, 0.4);
        border-color: var(--success);
      }

      .change-log-timestamp {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .change-log-modification {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 10px;
        padding: 8px 12px;
        background: rgba(124, 178, 255, 0.1);
        border-radius: 6px;
        border-left: 3px solid var(--accent);
      }

      .change-log-details {
        display: grid;
        gap: 8px;
        font-size: 13px;
      }

      .change-log-detail {
        display: flex;
        gap: 8px;
        padding: 6px 10px;
        background: rgba(124, 178, 255, 0.05);
        border-radius: 4px;
      }

      .change-log-detail-label {
        font-weight: 600;
        color: var(--success);
        min-width: 120px;
      }

      .change-log-detail-value {
        color: var(--text);
        flex: 1;
      }

      .change-log-filters {
        margin-top: 8px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        font-size: 12px;
      }

      .change-log-filter-item {
        padding: 4px 0;
        color: var(--muted);
      }

      .change-log-actions {
        display: flex;
        gap: 10px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      /* Export CSV Options Panel */
      .export-options-panel {
        background: rgba(124, 178, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 20px;
        margin-top: 16px;
        margin-bottom: 16px;
      }

      .export-options-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .export-options-description {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .delimiter-preview {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        color: var(--success);
        overflow-x: auto;
        white-space: nowrap;
      }

      .delimiter-preview-title {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 8px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Ubuntu, sans-serif;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìä Data Editor Pro</h1>
        <p class="subtitle">
          Editor masivo de archivos CSV y Excel con filtros y modificaci√≥n de
          datos
        </p>
      </div>

      <div class="status-bar info" id="statusBar">
        <span class="icon">‚ÑπÔ∏è</span>
        <span id="statusText"
          >Paso 1: Sube uno o varios archivos CSV/Excel para comenzar</span
        >
      </div>

      <!-- Stepper (4 PASOS) -->
      <div class="stepper">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">Cargar Archivos</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">Previsualizar</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">Filtros y Modificaciones</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-label">Exportar</div>
        </div>
      </div>

      <!-- STEP 1: Cargar Archivos -->
      <section id="step1" class="card">
        <h2>üìÅ Paso 1: Cargar Archivos</h2>
        <p class="description">
          Sube uno o varios archivos CSV o Excel (.xlsx, .xls). Los datos se
          consolidar√°n autom√°ticamente. Todos los archivos deben tener la misma
          estructura de columnas.
        </p>

        <div class="form-group">
          <label class="form-label">Seleccionar archivos (CSV o Excel)</label>
          <input
            type="file"
            id="fileInput"
            class="form-input"
            accept=".csv,.xlsx,.xls"
            multiple
          />
        </div>

        <div class="grid grid-3">
          <div class="form-group">
            <label class="form-label">Delimitador CSV</label>
            <select id="csvDelimiter" class="form-select">
              <option value="auto">Auto-detectar</option>
              <option value=",">Coma (,)</option>
              <option value=";">Punto y coma (;)</option>
              <option value="\t">Tabulador</option>
              <option value="|">Pipe (|)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Codificaci√≥n</label>
            <select id="encoding" class="form-select">
              <option value="utf-8">UTF-8</option>
              <option value="windows-1252">Windows-1252</option>
              <option value="iso-8859-1">ISO-8859-1</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Fila de encabezado</label>
            <input
              type="number"
              id="headerRow"
              class="form-input"
              value="1"
              min="1"
            />
          </div>
        </div>

        <div class="btn-group">
          <button id="loadFilesBtn" class="btn btn-primary" disabled>
            üìÇ Cargar y Procesar Archivos
          </button>
          <span class="pill" id="fileCountPill">0 archivos seleccionados</span>
        </div>

        <div id="fileList" class="file-list hidden"></div>
      </section>

      <!-- STEP 2: Previsualizar -->
      <section id="step2" class="card hidden">
        <h2>üëÅÔ∏è Paso 2: Previsualizar Datos</h2>
        <p class="description">
          Revisa los datos cargados. Verifica que las columnas y filas se hayan
          importado correctamente. (Solo se ven las 200 primeras lineas)
        </p>
        <div id="columnWarningBox" class="warning-box hidden">
          <h3>‚ö†Ô∏è Advertencia: Estructura de Columnas Inconsistente</h3>
          <p>
            Se han detectado diferencias en las columnas de los archivos
            importados. Los datos se han consolidado incluyendo todas las
            columnas encontradas, pero algunos archivos pueden tener campos
            vac√≠os donde no exist√≠a la columna original.
          </p>
          <div class="file-columns-list" id="fileColumnsList"></div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalRows">0</div>
            <div class="stat-label">Total de Filas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalColumns">0</div>
            <div class="stat-label">Total de Columnas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalFiles">0</div>
            <div class="stat-label">Archivos Cargados</div>
          </div>
        </div>

        <div class="table-container" style="margin-top: 20px">
          <table class="data-table" id="previewTable">
            <thead id="previewTableHead"></thead>
            <tbody id="previewTableBody"></tbody>
          </table>
        </div>

        <div class="btn-group" style="margin-top: 20px">
          <button id="backToStep1" class="btn btn-ghost">‚Üê Volver</button>
          <button id="goToStep3" class="btn btn-primary">
            Siguiente: Filtros y Modificaciones ‚Üí
          </button>
        </div>
      </section>

      <!-- STEP 3: Filtros y Modificaciones (FUSIONADO) -->
      <section id="step3" class="card hidden">
        <h2>üîç‚úèÔ∏è Paso 3: Filtros y Modificaciones</h2>
        <p class="description">
          Aplica filtros para segmentar tus datos y modifica los valores de las
          filas visibles en tiempo real. Los cambios se aplicar√°n solo a las
          filas que cumplan los filtros activos.
        </p>

        <!-- SUBSECCI√ìN: FILTROS -->
        <div class="subsection">
          <h3>üîç Filtros de Datos</h3>

          <div class="filter-item">
            <div class="filter-header">
              <div class="filter-title">Filtros Activos</div>
              <div style="display: flex; gap: 8px; align-items: center">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    background: rgba(124, 178, 255, 0.1);
                    padding: 4px 8px;
                    border-radius: 8px;
                    border: 1px solid var(--border);
                  "
                >
                  <span
                    style="
                      font-size: 11px;
                      font-weight: 600;
                      color: var(--muted);
                    "
                    >Modo:</span
                  >
                  <button
                    id="orFilterBtn"
                    class="btn btn-primary"
                    style="padding: 4px 12px; font-size: 11px; height: auto"
                  >
                    OR
                  </button>
                  <button
                    id="andFilterBtn"
                    class="btn btn-ghost"
                    style="padding: 4px 12px; font-size: 11px; height: auto"
                  >
                    AND
                  </button>
                </div>
                <button
                  id="clearFiltersBtn"
                  class="btn btn-ghost"
                  style="padding: 6px 12px; font-size: 12px"
                >
                  üóëÔ∏è Limpiar Todos
                </button>
              </div>
            </div>

            <div
              style="
                background: rgba(124, 178, 255, 0.08);
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 12px;
              "
            >
              <p
                style="
                  margin: 0;
                  font-size: 12px;
                  line-height: 1.6;
                  color: var(--muted);
                "
              >
                <strong style="color: var(--text)">Modo OR:</strong> Muestra
                filas que cumplan <strong>al menos uno</strong> de los filtros.
                <br /><em
                  >‚Üí Ejemplo: columna "Market" contiene "AFG" OR contiene "CHI"
                  ‚Üí Afghanistan, Chile, China, etc.</em
                >
                <br /><br />
                <strong style="color: var(--text)">Modo AND:</strong> Muestra
                filas que cumplan <strong>todos</strong> los filtros
                simult√°neamente. <br /><em
                  >‚Üí Ejemplo: columna "Marca" contiene "Coca-Cola" AND columna
                  "Market" contiene "CHI" ‚Üí solo Coca-Cola en Chile.</em
                >
              </p>
            </div>

            <div id="filtersContainer">
              <!-- Los filtros se a√±adir√°n din√°micamente aqu√≠ -->
            </div>
            <button
              id="addFilterBtn"
              class="btn btn-ghost"
              style="margin-top: 12px"
            >
              ‚ûï A√±adir Filtro
            </button>
          </div>

          <div class="stats">
            <div class="stat-card">
              <div class="stat-value" id="visibleRows">0</div>
              <div class="stat-label">Filas Visibles</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="filteredRows">0</div>
              <div class="stat-label">Filas Filtradas</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="filterPercentage">0%</div>
              <div class="stat-label">% Visible</div>
            </div>
          </div>
        </div>

        <!-- SUBSECCI√ìN: MODIFICACIONES -->
        <div class="subsection">
          <h3>‚úèÔ∏è Modificaci√≥n de Datos</h3>

          <div class="editor-section">
            <div class="grid grid-3">
              <div class="form-group">
                <label class="form-label">Campo a Modificar</label>
                <select id="fieldToEdit" class="form-select"></select>
              </div>

              <div class="form-group">
                <label class="form-label">Tipo de Modificaci√≥n</label>
                <select id="modifyType" class="form-select">
                  <option value="replace">Reemplazar Valor</option>
                  <option value="append">A√±adir al Final</option>
                  <option value="prepend">A√±adir al Inicio</option>
                  <option value="clear">Limpiar Campo</option>
                  <option value="findReplace">Buscar y Reemplazar</option>
                </select>
              </div>

              <div class="form-group" id="newValueGroup">
                <label class="form-label">Nuevo Valor</label>
                <input
                  type="text"
                  id="newValue"
                  class="form-input"
                  placeholder="Introduce el nuevo valor"
                />
              </div>
            </div>

            <div class="grid grid-2 hidden" id="findReplaceGroup">
              <div class="form-group">
                <label class="form-label">Buscar Texto</label>
                <input
                  type="text"
                  id="findText"
                  class="form-input"
                  placeholder="Texto a buscar"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Reemplazar Por</label>
                <input
                  type="text"
                  id="replaceText"
                  class="form-input"
                  placeholder="Texto de reemplazo"
                />
              </div>
            </div>

            <div class="btn-group">
              <button id="previewChangesBtn" class="btn btn-warning">
                üëÅÔ∏è Previsualizar Cambios
              </button>
              <button id="applyChangesBtn" class="btn btn-success" disabled>
                ‚úÖ Aplicar Cambios
              </button>
              <button id="undoChangesBtn" class="btn btn-danger" disabled>
                ‚Ü©Ô∏è Deshacer Cambios
              </button>
              <span class="pill info" id="changesPill"
                >0 filas ser√°n modificadas</span
              >
            </div>
          </div>

          <div class="stats" style="margin-top: 20px">
            <div class="stat-card">
              <div class="stat-value" id="modifiedRows">0</div>
              <div class="stat-label">Filas Modificadas</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="affectedRows">0</div>
              <div class="stat-label">Filas Afectadas</div>
            </div>
          </div>
        </div>

        <!-- HISTORIAL DE CAMBIOS -->
        <div class="change-log-panel">
          <div class="change-log-header" id="changeLogHeader">
            <div class="change-log-title">
              üìã Historial de Modificaciones
              <span class="pill success" id="changeLogCount">0 cambios</span>
            </div>
            <div>
              <button
                id="exportLogBtn"
                class="btn btn-ghost"
                style="padding: 6px 12px; font-size: 12px; margin-right: 10px"
              >
                üì• Exportar Log
              </button>
              <span class="change-log-toggle" id="changeLogToggle">üîΩ</span>
            </div>
          </div>
          <div class="change-log-content" id="changeLogContent">
            <div class="change-log-empty">
              No se han realizado modificaciones a√∫n. Los cambios aplicados se
              registrar√°n aqu√≠.
            </div>
          </div>
        </div>

        <!-- TABLA UNIFICADA -->
        <div class="table-container" style="margin-top: 20px">
          <table class="data-table" id="unifiedTable">
            <thead id="unifiedTableHead"></thead>
            <tbody id="unifiedTableBody"></tbody>
          </table>
        </div>

        <div class="btn-group" style="margin-top: 20px">
          <button id="backToStep2" class="btn btn-ghost">‚Üê Volver</button>
          <button id="goToStep4" class="btn btn-primary">
            Siguiente: Exportar ‚Üí
          </button>
        </div>
      </section>

      <!-- STEP 4: Exportar -->
      <section id="step4" class="card hidden">
        <h2>üíæ Paso 4: Exportar Resultados</h2>
        <p class="description">
          Exporta los datos modificados en formato CSV o Excel. Puedes exportar
          todas las filas o solo las filas visibles (filtradas).
        </p>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="exportTotalRows">0</div>
            <div class="stat-label">Total de Filas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="exportModifiedRows">0</div>
            <div class="stat-label">Filas Modificadas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="exportVisibleRows">0</div>
            <div class="stat-label">Filas Visibles</div>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top: 20px">
          <div class="form-group">
            <label class="form-label">Formato de Exportaci√≥n</label>
            <select id="exportFormat" class="form-select">
              <option value="csv">CSV</option>
              <option value="xlsx">Excel (.xlsx)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Qu√© Exportar</label>
            <select id="exportScope" class="form-select">
              <option value="all">Todas las Filas</option>
              <option value="visible">Solo Filas Visibles (Filtradas)</option>
              <option value="modified">Solo Filas Modificadas</option>
            </select>
          </div>
        </div>

        <!-- Panel de Opciones CSV -->
        <div id="csvOptionsPanel" class="export-options-panel">
          <div class="export-options-title">‚öôÔ∏è Opciones de Exportaci√≥n CSV</div>
          <p class="export-options-description">
            Configura c√≥mo quieres exportar tu archivo CSV. Selecciona el
            delimitador y otras opciones seg√∫n tus necesidades.
          </p>

          <div class="grid grid-3">
            <div class="form-group">
              <label class="form-label">Delimitador</label>
              <select id="exportCsvDelimiter" class="form-select">
                <option value=",">Coma (,)</option>
                <option value=";">Punto y coma (;)</option>
                <option value="\t">Tabulador (Tab)</option>
                <option value="|">Pipe (|)</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Codificaci√≥n</label>
              <select id="exportCsvEncoding" class="form-select">
                <option value="utf-8">UTF-8</option>
                <option value="utf-8-bom">UTF-8 con BOM</option>
                <option value="windows-1252">Windows-1252</option>
                <option value="iso-8859-1">ISO-8859-1</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Entrecomillado</label>
              <select id="exportCsvQuoting" class="form-select">
                <option value="minimal">M√≠nimo (solo si necesario)</option>
                <option value="all">Todos los campos</option>
                <option value="none">Sin comillas</option>
              </select>
            </div>
          </div>

          <div class="delimiter-preview">
            <div class="delimiter-preview-title">Vista previa del formato:</div>
            <div id="delimiterPreview"></div>
          </div>
        </div>

        <div class="table-container" style="margin-top: 20px">
          <table class="data-table" id="exportTable">
            <thead id="exportTableHead"></thead>
            <tbody id="exportTableBody"></tbody>
          </table>
        </div>

        <div class="btn-group" style="margin-top: 20px">
          <button id="backToStep3" class="btn btn-ghost">‚Üê Volver</button>
          <button id="exportDataBtn" class="btn btn-success">
            üíæ Exportar Datos
          </button>
          <button id="resetAllBtn" class="btn btn-danger">
            üîÑ Reiniciar Todo
          </button>
        </div>
      </section>
    </div>

    <script>
      // ============================================
      // GLOBAL STATE & UTILITIES
      // ============================================
      const State = {
        files: [],
        columns: [],
        data: [],
        originalData: [],
        filters: [],
        filterLogic: "or",
        modifications: [],
        modifiedRowIndices: new Set(),
        currentStep: 1,
        fileColumnsInfo: [],
        hasColumnMismatch: false,
        changeLog: [],
      };

      const Utils = {
        // Detectar delimitador CSV
        detectDelimiter(text) {
          const delimiters = [",", ";", "\t", "|"];
          const lines = text.split("\n").slice(0, 5);
          const counts = delimiters.map((delim) => {
            const counts = lines.map(
              (line) => (line.match(new RegExp(`\\${delim}`, "g")) || []).length
            );
            const avg = counts.reduce((a, b) => a + b, 0) / counts.length;
            const variance =
              counts.reduce((a, b) => a + Math.pow(b - avg, 2), 0) /
              counts.length;
            return { delim, score: avg / (1 + variance) };
          });
          counts.sort((a, b) => b.score - a.score);
          return counts[0].delim;
        },

        // Parsear CSV
        parseCSV(text, delimiter) {
          const lines = [];
          let current = "";
          let inQuotes = false;
          let row = [];

          for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            if (char === '"') {
              if (inQuotes && nextChar === '"') {
                current += '"';
                i++;
              } else {
                inQuotes = !inQuotes;
              }
            } else if (char === delimiter && !inQuotes) {
              row.push(current);
              current = "";
            } else if (char === "\n" && !inQuotes) {
              row.push(current);
              lines.push(row);
              row = [];
              current = "";
            } else if (char !== "\r") {
              current += char;
            }
          }

          if (current || row.length) {
            row.push(current);
            lines.push(row);
          }

          return lines.filter((line) => line.some((cell) => cell.trim()));
        },

        // Leer archivo como texto
        async readFileAsText(file, encoding = "utf-8") {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file, encoding);
          });
        },

        // Procesar archivo Excel
        async processExcelFile(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {
                  type: "array",
                  cellDates: true, // ‚Üê Forzar conversi√≥n a fechas
                  cellNF: false,
                  cellStyles: true,
                });

                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                  header: 1,
                  raw: false, // ‚Üê No usar valores raw
                  dateNF: "yyyy-mm-dd", // ‚Üê Formato de fecha
                });

                // Post-procesar para detectar n√∫meros que podr√≠an ser fechas
                const processedData = jsonData.map((row, rowIndex) => {
                  return row.map((cell, colIndex) => {
                    // Si es un n√∫mero entre 40000 y 50000 (rango aprox 2009-2036)
                    // probablemente es una fecha de Excel
                    if (
                      typeof cell === "number" &&
                      cell >= 25569 &&
                      cell <= 65000
                    ) {
                      return this.excelDateToJSDate(cell);
                    }
                    return cell;
                  });
                });

                resolve(processedData);
              } catch (error) {
                reject(error);
              }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
          });
        },

        // Convertir n√∫mero serial de Excel a fecha
        excelDateToJSDate(serial) {
          if (typeof serial !== "number") return serial;

          // Excel epoch: 1900-01-01 (con ajuste por bug de Excel)
          const epoch = new Date(1899, 11, 30);
          const days = Math.floor(serial);
          const milliseconds = days * 24 * 60 * 60 * 1000;
          const date = new Date(epoch.getTime() + milliseconds);

          // Formatear YYYY-MM-DD
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          return `${year}-${month}-${day}`;
        },
        // Normalizar datos
        normalizeData(rawData, headerRowIndex = 0) {
          if (!rawData || rawData.length === 0)
            return { columns: [], data: [] };

          const headers = rawData[headerRowIndex];
          const columns = headers.map((h, i) => h || `Column_${i + 1}`);

          const data = rawData
            .slice(headerRowIndex + 1)
            .map((row, rowIndex) => {
              const obj = { _rowId: rowIndex, _modified: false };
              columns.forEach((col, i) => {
                obj[col] = row[i] !== undefined ? row[i] : "";
              });
              return obj;
            });

          return { columns, data };
        },

        // Aplicar filtros (l√≥gica OR/AND din√°mica)
        applyFilters(data, filters) {
          if (!filters || filters.length === 0) return data;

          // Filtrar solo filtros v√°lidos
          const validFilters = filters.filter((f) => {
            if (!f.column || !f.operator) return false;
            // Para operadores que no necesitan valor
            if (["empty", "notEmpty"].includes(f.operator)) return true;
            // Para el resto, necesitan valor
            return f.value && String(f.value).trim() !== "";
          });

          if (validFilters.length === 0) return data;

          const logicMethod = State.filterLogic === "or" ? "some" : "every";

          return data.filter((row) => {
            return validFilters[logicMethod]((filter) => {
              const value = String(row[filter.column] || "").toLowerCase();
              const filterValue = String(filter.value || "").toLowerCase();

              switch (filter.operator) {
                case "contains":
                  return value.includes(filterValue);
                case "notContains":
                  return !value.includes(filterValue);
                case "equals":
                  return value === filterValue;
                case "notEquals":
                  return value !== filterValue;
                case "startsWith":
                  return value.startsWith(filterValue);
                case "endsWith":
                  return value.endsWith(filterValue);
                case "empty":
                  return value === "";
                case "notEmpty":
                  return value !== "";
                default:
                  return false;
              }
            });
          });
        },

        // Exportar CSV
        exportToCSV(data, columns, filename = "export.csv", options = {}) {
          const {
            delimiter = ",",
            encoding = "utf-8",
            quoting = "minimal",
          } = options;

          // Filtrar columnas internas (_rowId, _modified, etc.)
          const headers = columns.filter((col) => !col.startsWith("_"));

          const escapeField = (value) => {
            // Convertir a string, manejar null/undefined/n√∫meros
            let strValue = "";

            if (value === null || value === undefined) {
              strValue = "";
            } else if (typeof value === "number") {
              strValue = String(value);
            } else {
              strValue = String(value);
            }

            // Sin entrecomillado
            if (quoting === "none") {
              return strValue;
            }

            // Entrecomillar todos los campos
            if (quoting === "all") {
              return `"${strValue.replace(/"/g, '""')}"`;
            }

            // Entrecomillado m√≠nimo (solo si contiene caracteres especiales)
            const needsQuotes =
              strValue.includes(delimiter) ||
              strValue.includes('"') ||
              strValue.includes("\n") ||
              strValue.includes("\r") ||
              strValue.startsWith(" ") ||
              strValue.endsWith(" "); // espacios al inicio/final

            if (needsQuotes) {
              return `"${strValue.replace(/"/g, '""')}"`;
            }

            return strValue;
          };

          // Construir las filas del CSV
          const rows = [];

          // Fila de encabezados
          rows.push(headers.map((h) => escapeField(h)).join(delimiter));

          // Filas de datos - IMPORTANTE: asegurar que cada fila tenga TODOS los campos
          data.forEach((row) => {
            const rowData = headers.map((col) => {
              // Obtener el valor de cada columna, usar string vac√≠o si no existe
              const value = row.hasOwnProperty(col) ? row[col] : "";
              return escapeField(value);
            });
            rows.push(rowData.join(delimiter));
          });

          const csvContent = rows.join("\n");

          let finalContent = csvContent;
          let mimeType = "text/csv;charset=utf-8;";

          // A√±adir BOM si se seleccion√≥ UTF-8 con BOM
          if (encoding === "utf-8-bom") {
            finalContent = "\ufeff" + csvContent;
          }

          const blob = new Blob([finalContent], { type: mimeType });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          link.click();
        },

        // Exportar Excel
        exportToExcel(data, columns, filename = "export.xlsx") {
          const headers = columns.filter((col) => !col.startsWith("_"));
          const wsData = [
            headers,
            ...data.map((row) => headers.map((col) => row[col])),
          ];

          const ws = XLSX.utils.aoa_to_sheet(wsData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Data");
          XLSX.writeFile(wb, filename);
        },

        // Actualizar status
        setStatus(type, message, icon = "‚ÑπÔ∏è") {
          const statusBar = document.getElementById("statusBar");
          const statusText = document.getElementById("statusText");
          const iconEl = statusBar.querySelector(".icon");

          statusBar.className = `status-bar ${type}`;
          statusText.textContent = message;
          iconEl.textContent = icon;
        },
      };

      // ============================================
      // STEP NAVIGATION
      // ============================================
      const Navigation = {
        goToStep(step) {
          // Ocultar todos los steps
          for (let i = 1; i <= 4; i++) {
            const section = document.getElementById(`step${i}`);
            const stepEl = document.querySelector(`.step[data-step="${i}"]`);

            if (section) section.classList.toggle("hidden", i !== step);
            if (stepEl) {
              stepEl.classList.remove("active", "completed");
              if (i === step) stepEl.classList.add("active");
              if (i < step) stepEl.classList.add("completed");
            }
          }

          State.currentStep = step;
          window.scrollTo({ top: 0, behavior: "smooth" });
        },

        setupNavigation() {
          // Navegaci√≥n entre pasos
          document
            .getElementById("backToStep1")
            ?.addEventListener("click", () => this.goToStep(1));
          document
            .getElementById("backToStep2")
            ?.addEventListener("click", () => this.goToStep(2));
          document
            .getElementById("backToStep3")
            ?.addEventListener("click", () => this.goToStep(3));

          document
            .getElementById("goToStep3")
            ?.addEventListener("click", () => {
              this.goToStep(3);
              UnifiedManager.init();
            });

          document
            .getElementById("goToStep4")
            ?.addEventListener("click", () => {
              this.goToStep(4);
              ExportManager.init();
            });

          // Click en stepper
          document.querySelectorAll(".step").forEach((step) => {
            step.addEventListener("click", () => {
              const stepNum = parseInt(step.getAttribute("data-step"));
              if (
                stepNum <= State.currentStep ||
                stepNum === State.currentStep + 1
              ) {
                this.goToStep(stepNum);
                if (stepNum === 3) UnifiedManager.init();
                if (stepNum === 4) ExportManager.init();
              }
            });
          });
        },
      };

      // ============================================
      // FILE LOADER (STEP 1)
      // ============================================
      const FileLoader = {
        init() {
          const fileInput = document.getElementById("fileInput");
          const loadBtn = document.getElementById("loadFilesBtn");
          const fileCountPill = document.getElementById("fileCountPill");

          fileInput.addEventListener("change", (e) => {
            const files = Array.from(e.target.files);
            State.files = files;

            fileCountPill.textContent = `${files.length} archivo${
              files.length !== 1 ? "s" : ""
            } seleccionado${files.length !== 1 ? "s" : ""}`;
            loadBtn.disabled = files.length === 0;

            this.displayFileList(files);
          });

          loadBtn.addEventListener("click", () => this.loadFiles());
        },

        displayFileList(files) {
          const fileList = document.getElementById("fileList");
          const fileListContent = files
            .map(
              (file) => `
      <div class="file-item">
        <div>
          <div class="file-name">üìÑ ${file.name}</div>
          <div class="file-meta">${(file.size / 1024).toFixed(2)} KB</div>
        </div>
      </div>
    `
            )
            .join("");

          fileList.innerHTML = fileListContent;
          fileList.classList.remove("hidden");
        },

        async loadFiles() {
          try {
            Utils.setStatus("info", "Cargando archivos...", "‚è≥");

            const delimiter = document.getElementById("csvDelimiter").value;
            const encoding = document.getElementById("encoding").value;
            const headerRow =
              parseInt(document.getElementById("headerRow").value) - 1;

            let allData = [];
            let allColumns = new Set();
            let fileColumnsInfo = [];

            // Procesar cada archivo
            for (const file of State.files) {
              const isExcel = file.name.match(/\.(xlsx|xls)$/i);
              let rawData;

              if (isExcel) {
                rawData = await Utils.processExcelFile(file);
              } else {
                const text = await Utils.readFileAsText(file, encoding);
                const delim =
                  delimiter === "auto"
                    ? Utils.detectDelimiter(text)
                    : delimiter;
                rawData = Utils.parseCSV(text, delim === "\\t" ? "\t" : delim);
              }

              const normalized = Utils.normalizeData(rawData, headerRow);

              fileColumnsInfo.push({
                fileName: file.name,
                columns: [...normalized.columns],
                rowCount: normalized.data.length,
              });

              // Agregar todas las columnas al set global
              normalized.columns.forEach((col) => allColumns.add(col));

              allData = allData.concat(normalized.data);
            }

            // Convertir set a array
            const finalColumns = Array.from(allColumns);

            // Detectar si hay discrepancias en columnas
            let hasColumnMismatch = false;
            if (State.files.length > 1) {
              const firstFileColumns = new Set(fileColumnsInfo[0].columns);
              for (let i = 1; i < fileColumnsInfo.length; i++) {
                const currentColumns = new Set(fileColumnsInfo[i].columns);
                if (firstFileColumns.size !== currentColumns.size) {
                  hasColumnMismatch = true;
                  break;
                }
                for (let col of firstFileColumns) {
                  if (!currentColumns.has(col)) {
                    hasColumnMismatch = true;
                    break;
                  }
                }
                if (hasColumnMismatch) break;
              }
            }

            // Normalizar todas las filas para que tengan todas las columnas
            allData = allData.map((row) => {
              const normalizedRow = { ...row };
              finalColumns.forEach((col) => {
                if (!(col in normalizedRow)) {
                  normalizedRow[col] = "";
                }
              });
              return normalizedRow;
            });

            State.columns = finalColumns;
            State.data = allData;
            State.originalData = JSON.parse(JSON.stringify(allData));
            State.fileColumnsInfo = fileColumnsInfo;
            State.hasColumnMismatch = hasColumnMismatch;

            Utils.setStatus(
              "success",
              `‚úÖ ${allData.length} filas cargadas desde ${State.files.length} archivo(s)`,
              "‚úÖ"
            );

            PreviewManager.render();
            Navigation.goToStep(2);
          } catch (error) {
            Utils.setStatus(
              "error",
              `‚ùå Error al cargar archivos: ${error.message}`,
              "‚ùå"
            );
            console.error(error);
          }
        },
      };

      // ============================================
      // PREVIEW MANAGER (STEP 2)
      // ============================================
      const PreviewManager = {
        render() {
          const thead = document.getElementById("previewTableHead");
          const tbody = document.getElementById("previewTableBody");

          // Stats
          document.getElementById("totalRows").textContent = State.data.length;
          document.getElementById("totalColumns").textContent =
            State.columns.length;
          document.getElementById("totalFiles").textContent =
            State.files.length;

          // Mostrar warning si hay inconsistencias
          this.renderColumnWarning();

          // Headers
          const headers = State.columns.filter((col) => !col.startsWith("_"));
          thead.innerHTML = `<tr>${headers
            .map((col) => `<th>${col}</th>`)
            .join("")}</tr>`;

          // Body (primeras 200 filas)
          const displayData = State.data.slice(0, 200);
          tbody.innerHTML = displayData
            .map(
              (row) => `
      <tr>
        ${headers.map((col) => `<td>${row[col] || ""}</td>`).join("")}
      </tr>
    `
            )
            .join("");
        },

        // Renderizar warning de columnas inconsistentes
        renderColumnWarning() {
          const warningBox = document.getElementById("columnWarningBox");
          const fileColumnsList = document.getElementById("fileColumnsList");

          if (!State.hasColumnMismatch || State.files.length <= 1) {
            warningBox.classList.add("hidden");
            return;
          }

          warningBox.classList.remove("hidden");

          // Obtener todas las columnas √∫nicas
          const allColumns = new Set(
            State.columns.filter((col) => !col.startsWith("_"))
          );

          // Generar HTML para cada archivo
          const filesHTML = State.fileColumnsInfo
            .map((fileInfo, index) => {
              const fileColumns = new Set(
                fileInfo.columns.filter((col) => !col.startsWith("_"))
              );

              // Columnas que le faltan a este archivo
              const missingColumns = [...allColumns].filter(
                (col) => !fileColumns.has(col)
              );

              // Columnas que tiene este archivo
              const presentColumns = [...fileColumns];

              return `
        <div class="file-columns-item">
          <div class="file-name-header">
            üìÑ ${fileInfo.fileName} 
            <span style="color:var(--muted);font-weight:400;font-size:11px;">
              (${fileInfo.rowCount} filas, ${fileColumns.size} columnas)
            </span>
          </div>
          <div class="columns-list">
            ${presentColumns
              .map((col) => `<span class="column-tag">${col}</span>`)
              .join("")}
            ${
              missingColumns.length > 0
                ? missingColumns
                    .map(
                      (col) =>
                        `<span class="column-tag missing">‚ùå ${col}</span>`
                    )
                    .join("")
                : ""
            }
          </div>
        </div>
      `;
            })
            .join("");

          fileColumnsList.innerHTML = filesHTML;

          // Actualizar status
          Utils.setStatus(
            "warning",
            `‚ö†Ô∏è Archivos con estructuras diferentes detectados. Revisa la advertencia en el Paso 2.`,
            "‚ö†Ô∏è"
          );
        },
      };

      // ============================================
      // UNIFIED MANAGER (STEP 3 - FILTROS + EDITOR)
      // ============================================
      const UnifiedManager = {
        previewMode: false,

        init() {
          this.initFilters();
          this.initEditor();
          this.initChangeLog();
          this.render();
        },

        // FILTROS
        initFilters() {
          const addBtn = document.getElementById("addFilterBtn");
          const clearBtn = document.getElementById("clearFiltersBtn");
          const orBtn = document.getElementById("orFilterBtn");
          const andBtn = document.getElementById("andFilterBtn");

          // Remover listeners previos
          const newAddBtn = addBtn.cloneNode(true);
          addBtn.parentNode.replaceChild(newAddBtn, addBtn);

          document
            .getElementById("addFilterBtn")
            .addEventListener("click", () => this.addFilter());
          clearBtn.addEventListener("click", () => this.clearFilters());
          orBtn.addEventListener("click", () => this.setFilterLogic("or"));
          andBtn.addEventListener("click", () => this.setFilterLogic("and"));
        },

        addFilter() {
          const filterId = Date.now();
          const filter = {
            id: filterId,
            column: State.columns[0],
            operator: "contains",
            value: "",
          };

          State.filters.push(filter);
          this.renderFilters();
        },

        removeFilter(id) {
          State.filters = State.filters.filter((f) => f.id !== id);
          this.renderFilters();
          this.applyFilters();
        },

        // Obtener valores √∫nicos de una columna
        getUniqueValues(columnName) {
          const values = new Set();
          State.data.forEach((row) => {
            const value = row[columnName];
            if (value !== null && value !== undefined && value !== "") {
              values.add(String(value).trim());
            }
          });
          return Array.from(values).sort((a, b) => {
            // Intentar ordenar num√©ricamente si es posible, sino alfab√©ticamente
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            if (!isNaN(numA) && !isNaN(numB)) {
              return numA - numB;
            }
            return a.localeCompare(b, "es", { sensitivity: "base" });
          });
        },

        renderFilters() {
          const container = document.getElementById("filtersContainer");
          const columns = State.columns.filter((col) => !col.startsWith("_"));

          if (State.filters.length === 0) {
            container.innerHTML =
              '<p style="color:var(--muted);font-size:13px;">No hay filtros activos. Haz clic en "A√±adir Filtro" para comenzar.</p>';
            return;
          }

          container.innerHTML = State.filters
            .map((filter) => {
              const isEqualsOperator = filter.operator === "equals";
              const needsValue = !["empty", "notEmpty"].includes(
                filter.operator
              );

              // Obtener valores √∫nicos si el operador es "equals"
              let uniqueValues = [];
              if (isEqualsOperator && filter.column) {
                uniqueValues = this.getUniqueValues(filter.column);
              }

              // Generar el campo de valor (input o select seg√∫n el operador)
              let valueField = "";
              if (needsValue) {
                if (isEqualsOperator) {
                  // Select con valores √∫nicos
                  valueField = `
            <select class="form-select" data-filter-id="${
              filter.id
            }" data-field="value">
              <option value="">-- Seleccionar valor --</option>
              ${uniqueValues
                .map(
                  (val) => `
                <option value="${val}" ${
                    filter.value === val ? "selected" : ""
                  }>${val}</option>
              `
                )
                .join("")}
            </select>
          `;
                } else {
                  // Input de texto normal
                  valueField = `
            <input type="text" class="form-input" data-filter-id="${filter.id}" data-field="value" 
                   value="${filter.value}" placeholder="Valor a filtrar">
          `;
                }
              } else {
                // Operadores que no necesitan valor (empty, notEmpty)
                valueField = `
          <input type="text" class="form-input" value="(no requerido)" disabled>
        `;
              }

              return `
        <div class="grid grid-4" style="margin-bottom:12px;align-items:end;" data-filter-container="${
          filter.id
        }">
          <div class="form-group" style="margin:0;">
            <label class="form-label" style="font-size:12px;">Campo</label>
            <select class="form-select" data-filter-id="${
              filter.id
            }" data-field="column">
              ${columns
                .map(
                  (col) =>
                    `<option value="${col}" ${
                      filter.column === col ? "selected" : ""
                    }>${col}</option>`
                )
                .join("")}
            </select>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label" style="font-size:12px;">Operador</label>
            <select class="form-select" data-filter-id="${
              filter.id
            }" data-field="operator">
              <option value="contains" ${
                filter.operator === "contains" ? "selected" : ""
              }>Contiene</option>
              <option value="notContains" ${
                filter.operator === "notContains" ? "selected" : ""
              }>No contiene</option>
              <option value="equals" ${
                filter.operator === "equals" ? "selected" : ""
              }>Igual a</option>
              <option value="notEquals" ${
                filter.operator === "notEquals" ? "selected" : ""
              }>Diferente de</option>
              <option value="startsWith" ${
                filter.operator === "startsWith" ? "selected" : ""
              }>Empieza con</option>
              <option value="endsWith" ${
                filter.operator === "endsWith" ? "selected" : ""
              }>Termina con</option>
              <option value="empty" ${
                filter.operator === "empty" ? "selected" : ""
              }>Est√° vac√≠o</option>
              <option value="notEmpty" ${
                filter.operator === "notEmpty" ? "selected" : ""
              }>No est√° vac√≠o</option>
            </select>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label" style="font-size:12px;">
              Valor
              ${
                isEqualsOperator
                  ? `<span class="unique-indicator" style="color:var(--success);font-size:10px;margin-left:4px;">(${uniqueValues.length} opciones)</span>`
                  : ""
              }
            </label>
            ${valueField}
          </div>
          <button class="btn btn-danger" data-remove-filter="${
            filter.id
          }" style="height:38px;">üóëÔ∏è</button>
        </div>
      `;
            })
            .join("");

          // Event listeners
          this.attachFilterEvents();
        },

        attachFilterEvents() {
          const container = document.getElementById("filtersContainer");

          // Listeners para cambios en columna
          container
            .querySelectorAll('select[data-field="column"]')
            .forEach((el) => {
              el.addEventListener("change", (e) => {
                const id = parseInt(e.target.getAttribute("data-filter-id"));
                const filter = State.filters.find((f) => f.id === id);

                if (filter) {
                  filter.column = e.target.value;

                  // Si el operador es "equals", re-renderizar para actualizar las opciones
                  if (filter.operator === "equals") {
                    filter.value = ""; // Resetear el valor cuando cambia la columna
                    this.renderFilters();
                  } else {
                    this.applyFilters();
                  }
                }
              });
            });

          // Listeners para cambios en operador
          container
            .querySelectorAll('select[data-field="operator"]')
            .forEach((el) => {
              el.addEventListener("change", (e) => {
                const id = parseInt(e.target.getAttribute("data-filter-id"));
                const filter = State.filters.find((f) => f.id === id);

                if (filter) {
                  const oldOperator = filter.operator;
                  const newOperator = e.target.value;
                  filter.operator = newOperator;

                  // Si cambia de/a "equals", re-renderizar para cambiar input/select
                  if (oldOperator === "equals" || newOperator === "equals") {
                    if (newOperator === "equals") {
                      filter.value = ""; // Resetear valor al cambiar a equals
                    }
                    this.renderFilters();
                  } else {
                    this.applyFilters();
                  }
                }
              });
            });

          // Listeners para cambios en valor (tanto input como select)
          container
            .querySelectorAll(
              'input[data-field="value"], select[data-field="value"]'
            )
            .forEach((el) => {
              const eventType = el.tagName === "SELECT" ? "change" : "input";

              el.addEventListener(eventType, (e) => {
                const id = parseInt(e.target.getAttribute("data-filter-id"));
                const filter = State.filters.find((f) => f.id === id);

                if (filter) {
                  filter.value = e.target.value;
                  this.applyFilters();
                }
              });
            });

          // Listeners para botones de eliminar
          container.querySelectorAll("[data-remove-filter]").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const id = parseInt(
                e.target.closest("button").getAttribute("data-remove-filter")
              );
              this.removeFilter(id);
            });
          });
        },

        applyFilters() {
          const filteredData = Utils.applyFilters(State.data, State.filters);
          this.renderTable(filteredData);
          this.updateFilterStats(filteredData);
          this.updateEditorStats();
        },

        clearFilters() {
          State.filters = [];
          this.renderFilters();
          this.applyFilters();
        },

        setFilterLogic(mode) {
          if (State.filterLogic === mode) return;

          State.filterLogic = mode;

          const orBtn = document.getElementById("orFilterBtn");
          const andBtn = document.getElementById("andFilterBtn");

          if (mode === "or") {
            orBtn.classList.remove("btn-ghost");
            orBtn.classList.add("btn-primary");
            andBtn.classList.remove("btn-primary", "btn-success");
            andBtn.classList.add("btn-ghost");
          } else {
            andBtn.classList.remove("btn-ghost");
            andBtn.classList.add("btn-success");
            orBtn.classList.remove("btn-primary");
            orBtn.classList.add("btn-ghost");
          }

          this.applyFilters();

          const modeText =
            mode === "or"
              ? "OR (cualquier filtro coincide)"
              : "AND (todos los filtros deben coincidir)";
          Utils.setStatus("info", `Modo de filtros: ${modeText}`, "üîÑ");
        },

        updateFilterStats(filteredData) {
          const visible = filteredData.length;
          const total = State.data.length;
          const filtered = total - visible;
          const percentage =
            total > 0 ? ((visible / total) * 100).toFixed(1) : 0;

          document.getElementById("visibleRows").textContent = visible;
          document.getElementById("filteredRows").textContent = filtered;
          document.getElementById(
            "filterPercentage"
          ).textContent = `${percentage}%`;
        },

        // EDITOR
        initEditor() {
          const modifyType = document.getElementById("modifyType");
          const previewBtn = document.getElementById("previewChangesBtn");
          const applyBtn = document.getElementById("applyChangesBtn");
          const undoBtn = document.getElementById("undoChangesBtn");

          // Poblar selector de campos
          const fieldSelect = document.getElementById("fieldToEdit");
          const columns = State.columns.filter((col) => !col.startsWith("_"));
          fieldSelect.innerHTML = columns
            .map((col) => `<option value="${col}">${col}</option>`)
            .join("");

          modifyType.addEventListener("change", () => {
            const isFindReplace = modifyType.value === "findReplace";
            document
              .getElementById("findReplaceGroup")
              .classList.toggle("hidden", !isFindReplace);
            document
              .getElementById("newValueGroup")
              .classList.toggle(
                "hidden",
                isFindReplace || modifyType.value === "clear"
              );
          });

          previewBtn.addEventListener("click", () => this.togglePreview());
          applyBtn.addEventListener("click", () => this.applyChanges());
          undoBtn.addEventListener("click", () => this.undoChanges());
        },

        // CHANGE LOG
        initChangeLog() {
          const header = document.getElementById("changeLogHeader");
          const toggle = document.getElementById("changeLogToggle");
          const content = document.getElementById("changeLogContent");
          const exportBtn = document.getElementById("exportLogBtn");

          // Toggle panel
          header.addEventListener("click", (e) => {
            // No colapsar si se hace click en el bot√≥n de exportar
            if (e.target.closest("#exportLogBtn")) return;

            content.classList.toggle("collapsed");
            toggle.classList.toggle("collapsed");
          });

          // Exportar log
          exportBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            this.exportChangeLog();
          });

          this.renderChangeLog();
        },

        addToChangeLog(modification) {
          const timestamp = new Date();
          const logEntry = {
            timestamp: timestamp,
            modification: modification,
            filters: JSON.parse(JSON.stringify(State.filters)),
            filterLogic: State.filterLogic,
            affectedRows: modification.affectedRows,
          };

          State.changeLog.push(logEntry);
          this.renderChangeLog();
        },

        renderChangeLog() {
          const content = document.getElementById("changeLogContent");
          const countPill = document.getElementById("changeLogCount");

          countPill.textContent = `${State.changeLog.length} cambio${
            State.changeLog.length !== 1 ? "s" : ""
          }`;

          if (State.changeLog.length === 0) {
            content.innerHTML = `
        <div class="change-log-empty">
          No se han realizado modificaciones a√∫n. Los cambios aplicados se registrar√°n aqu√≠.
        </div>
      `;
            return;
          }

          // Renderizar en orden inverso (m√°s reciente primero)
          const logsHTML = [...State.changeLog]
            .reverse()
            .map((entry, index) => {
              const actualIndex = State.changeLog.length - 1 - index;
              const time = entry.timestamp.toLocaleString("es-ES", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });

              const mod = entry.modification;
              let modificationText = "";

              switch (mod.type) {
                case "replace":
                  modificationText = `Campo "<strong>${mod.field}</strong>" ‚Üí Reemplazar con "<strong>${mod.newValue}</strong>"`;
                  break;
                case "append":
                  modificationText = `Campo "<strong>${mod.field}</strong>" ‚Üí A√±adir al final: "<strong>${mod.newValue}</strong>"`;
                  break;
                case "prepend":
                  modificationText = `Campo "<strong>${mod.field}</strong>" ‚Üí A√±adir al inicio: "<strong>${mod.newValue}</strong>"`;
                  break;
                case "clear":
                  modificationText = `Campo "<strong>${mod.field}</strong>" ‚Üí Limpiar campo`;
                  break;
                case "findReplace":
                  modificationText = `Campo "<strong>${mod.field}</strong>" ‚Üí Buscar "<strong>${mod.findText}</strong>" y reemplazar por "<strong>${mod.replaceText}</strong>"`;
                  break;
              }

              const filtersHTML =
                entry.filters.length > 0
                  ? `
        <div class="change-log-filters">
          <strong>Filtros aplicados (${entry.filterLogic.toUpperCase()}):</strong>
          ${entry.filters
            .map(
              (f) => `
            <div class="change-log-filter-item">
              ‚Ä¢ ${f.column} ${this.getOperatorText(f.operator)} ${
                f.value ? '"' + f.value + '"' : ""
              }
            </div>
          `
            )
            .join("")}
        </div>
      `
                  : '<div class="change-log-detail"><span class="change-log-detail-label">Filtros:</span><span class="change-log-detail-value">Sin filtros (todas las filas)</span></div>';

              return `
        <div class="change-log-item">
          <div class="change-log-timestamp">
            üïí ${time} <span style="color:var(--border);">|</span> Cambio #${
                actualIndex + 1
              }
          </div>
          <div class="change-log-modification">
            ${modificationText}
          </div>
          <div class="change-log-details">
            <div class="change-log-detail">
              <span class="change-log-detail-label">Filas afectadas:</span>
              <span class="change-log-detail-value"><strong style="color:var(--success);">${
                entry.affectedRows
              }</strong> filas modificadas</span>
            </div>
            ${filtersHTML}
          </div>
        </div>
      `;
            })
            .join("");

          content.innerHTML = logsHTML;
        },

        getOperatorText(operator) {
          const operators = {
            contains: "contiene",
            notContains: "no contiene",
            equals: "igual a",
            notEquals: "diferente de",
            startsWith: "empieza con",
            endsWith: "termina con",
            empty: "est√° vac√≠o",
            notEmpty: "no est√° vac√≠o",
          };
          return operators[operator] || operator;
        },

        exportChangeLog() {
          if (State.changeLog.length === 0) {
            alert("No hay cambios registrados para exportar.");
            return;
          }

          const timestamp = new Date()
            .toISOString()
            .replace(/[:.]/g, "-")
            .slice(0, -5);
          const filename = `change_log_${timestamp}.txt`;

          let logText =
            "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
          logText += "               DATA EDITOR PRO - HISTORIAL DE CAMBIOS\n";
          logText +=
            "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
          logText += `Fecha de exportaci√≥n: ${new Date().toLocaleString(
            "es-ES"
          )}\n`;
          logText += `Total de modificaciones: ${State.changeLog.length}\n`;
          logText += `Total de filas en dataset: ${State.data.length}\n`;
          logText += `Total de filas modificadas: ${State.modifiedRowIndices.size}\n\n`;

          State.changeLog.forEach((entry, index) => {
            const time = entry.timestamp.toLocaleString("es-ES", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });

            const mod = entry.modification;

            logText +=
              "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
            logText += `CAMBIO #${index + 1}\n`;
            logText +=
              "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
            logText += `Fecha/Hora: ${time}\n\n`;

            logText += `MODIFICACI√ìN:\n`;
            logText += `  Campo: ${mod.field}\n`;
            logText += `  Tipo: ${this.getModificationTypeText(mod.type)}\n`;

            switch (mod.type) {
              case "replace":
                logText += `  Nuevo valor: "${mod.newValue}"\n`;
                break;
              case "append":
                logText += `  Texto a√±adido al final: "${mod.newValue}"\n`;
                break;
              case "prepend":
                logText += `  Texto a√±adido al inicio: "${mod.newValue}"\n`;
                break;
              case "clear":
                logText += `  Acci√≥n: Campo limpiado (vac√≠o)\n`;
                break;
              case "findReplace":
                logText += `  Buscar: "${mod.findText}"\n`;
                logText += `  Reemplazar por: "${mod.replaceText}"\n`;
                break;
            }

            logText += `\nFILAS AFECTADAS: ${entry.affectedRows}\n\n`;

            if (entry.filters.length > 0) {
              logText += `FILTROS APLICADOS (L√≥gica: ${entry.filterLogic.toUpperCase()}):\n`;
              entry.filters.forEach((filter, i) => {
                logText += `  ${i + 1}. ${filter.column} ${this.getOperatorText(
                  filter.operator
                )}`;
                if (filter.value) {
                  logText += ` "${filter.value}"`;
                }
                logText += "\n";
              });
            } else {
              logText += `FILTROS: Ninguno (se aplic√≥ a todas las filas)\n`;
            }

            logText += "\n";
          });

          logText +=
            "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
          logText += "                          FIN DEL LOG\n";
          logText +=
            "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

          const blob = new Blob([logText], {
            type: "text/plain;charset=utf-8",
          });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          link.click();

          Utils.setStatus("success", `Log exportado: ${filename}`, "üì•");
        },

        getModificationTypeText(type) {
          const types = {
            replace: "Reemplazar Valor",
            append: "A√±adir al Final",
            prepend: "A√±adir al Inicio",
            clear: "Limpiar Campo",
            findReplace: "Buscar y Reemplazar",
          };
          return types[type] || type;
        },

        togglePreview() {
          if (this.previewMode) {
            this.cancelPreview();
          } else {
            this.previewChanges();
          }
        },

        previewChanges() {
          const field = document.getElementById("fieldToEdit").value;
          const modifyType = document.getElementById("modifyType").value;
          const newValue = document.getElementById("newValue").value;
          const findText = document.getElementById("findText").value;
          const replaceText = document.getElementById("replaceText").value;

          const filteredData = Utils.applyFilters(State.data, State.filters);
          let affectedCount = 0;

          filteredData.forEach((row) => {
            const currentValue = String(row[field] || "");
            let newVal = currentValue;

            switch (modifyType) {
              case "replace":
                newVal = newValue;
                break;
              case "append":
                newVal = currentValue + newValue;
                break;
              case "prepend":
                newVal = newValue + currentValue;
                break;
              case "clear":
                newVal = "";
                break;
              case "findReplace":
                newVal = currentValue.replace(
                  new RegExp(findText, "g"),
                  replaceText
                );
                break;
            }

            if (newVal !== currentValue) {
              row[`_preview_${field}`] = newVal;
              affectedCount++;
            } else {
              delete row[`_preview_${field}`];
            }
          });

          this.previewMode = true;
          this.renderTable(filteredData);

          const previewBtn = document.getElementById("previewChangesBtn");
          previewBtn.innerHTML = "‚Üê Atr√°s";
          previewBtn.classList.remove("btn-warning");
          previewBtn.classList.add("btn-ghost");

          document.getElementById(
            "changesPill"
          ).textContent = `${affectedCount} fila${
            affectedCount !== 1 ? "s" : ""
          } ser√°${affectedCount !== 1 ? "n" : ""} modificada${
            affectedCount !== 1 ? "s" : ""
          }`;
          document.getElementById("applyChangesBtn").disabled =
            affectedCount === 0;

          Utils.setStatus(
            "warning",
            `Vista previa: ${affectedCount} filas ser√°n modificadas`,
            "üëÅÔ∏è"
          );
        },

        cancelPreview() {
          // Limpiar todas las previsualizaciones
          State.data.forEach((row) => {
            State.columns.forEach((col) => {
              delete row[`_preview_${col}`];
            });
          });

          this.previewMode = false;
          const filteredData = Utils.applyFilters(State.data, State.filters);
          this.renderTable(filteredData);

          const previewBtn = document.getElementById("previewChangesBtn");
          previewBtn.innerHTML = "üëÅÔ∏è Previsualizar Cambios";
          previewBtn.classList.remove("btn-ghost");
          previewBtn.classList.add("btn-warning");

          document.getElementById("changesPill").textContent =
            "0 filas ser√°n modificadas";
          document.getElementById("applyChangesBtn").disabled = true;

          Utils.setStatus("info", "Vista previa cancelada", "‚ÑπÔ∏è");
        },

        applyChanges() {
          const field = document.getElementById("fieldToEdit").value;
          const modifyType = document.getElementById("modifyType").value;
          const newValue = document.getElementById("newValue").value;
          const findText = document.getElementById("findText").value;
          const replaceText = document.getElementById("replaceText").value;

          let affectedCount = 0;

          State.data.forEach((row) => {
            if (row[`_preview_${field}`] !== undefined) {
              row[field] = row[`_preview_${field}`];
              row._modified = true;
              State.modifiedRowIndices.add(row._rowId);
              delete row[`_preview_${field}`];
              affectedCount++;
            }
          });

          // Registrar cambio en el log
          const modification = {
            field: field,
            type: modifyType,
            newValue: newValue,
            findText: findText,
            replaceText: replaceText,
            affectedRows: affectedCount,
          };
          this.addToChangeLog(modification);

          this.previewMode = false;
          const filteredData = Utils.applyFilters(State.data, State.filters);
          this.renderTable(filteredData);
          this.updateEditorStats();

          const previewBtn = document.getElementById("previewChangesBtn");
          previewBtn.innerHTML = "üëÅÔ∏è Previsualizar Cambios";
          previewBtn.classList.remove("btn-ghost");
          previewBtn.classList.add("btn-warning");

          document.getElementById("applyChangesBtn").disabled = true;
          document.getElementById("undoChangesBtn").disabled = false;
          document.getElementById("changesPill").textContent =
            "0 filas ser√°n modificadas";

          Utils.setStatus(
            "success",
            `‚úÖ ${affectedCount} filas modificadas y registradas en el historial`,
            "‚úÖ"
          );
        },

        undoChanges() {
          State.data = JSON.parse(JSON.stringify(State.originalData));
          State.modifiedRowIndices.clear();
          State.changeLog = [];

          this.previewMode = false;
          const filteredData = Utils.applyFilters(State.data, State.filters);
          this.renderTable(filteredData);
          this.updateEditorStats();
          this.renderChangeLog();

          const previewBtn = document.getElementById("previewChangesBtn");
          previewBtn.innerHTML = "üëÅÔ∏è Previsualizar Cambios";
          previewBtn.classList.remove("btn-ghost");
          previewBtn.classList.add("btn-warning");

          document.getElementById("undoChangesBtn").disabled = true;
          Utils.setStatus(
            "info",
            "Cambios deshechos. Datos y log restaurados al estado original",
            "‚Ü©Ô∏è"
          );
        },

        updateEditorStats() {
          const filteredData = Utils.applyFilters(State.data, State.filters);
          document.getElementById("modifiedRows").textContent =
            State.modifiedRowIndices.size;
          document.getElementById("affectedRows").textContent =
            filteredData.length;
        },

        // TABLA UNIFICADA
        render() {
          this.renderFilters();
          this.applyFilters();
        },

        renderTable(data) {
          const thead = document.getElementById("unifiedTableHead");
          const tbody = document.getElementById("unifiedTableBody");
          const headers = State.columns.filter((col) => !col.startsWith("_"));

          thead.innerHTML = `<tr>${headers
            .map((col) => `<th>${col}</th>`)
            .join("")}</tr>`;

          const displayData = data.slice(0, 500);
          tbody.innerHTML = displayData
            .map((row) => {
              const cells = headers
                .map((col) => {
                  const previewKey = `_preview_${col}`;
                  const hasPreview = row[previewKey] !== undefined;
                  const value = hasPreview ? row[previewKey] : row[col] || "";
                  const originalValue = row[col] || "";

                  return hasPreview
                    ? `<td style="background:rgba(251,191,36,0.2);"><del style="color:var(--muted);">${originalValue}</del> ‚Üí <strong>${value}</strong></td>`
                    : `<td>${value}</td>`;
                })
                .join("");

              return `<tr class="${
                row._modified ? "modified" : ""
              }">${cells}</tr>`;
            })
            .join("");
        },
      };

      // ============================================
      // EXPORT MANAGER (STEP 4)
      // ============================================
      const ExportManager = {
        init() {
          this.render();
          this.setupEvents();
          this.updateCsvOptionsVisibility();
          this.updateDelimiterPreview();
        },

        setupEvents() {
          const exportBtn = document.getElementById("exportDataBtn");
          const newExportBtn = exportBtn.cloneNode(true);
          exportBtn.replaceWith(newExportBtn);

          const resetBtn = document.getElementById("resetAllBtn");
          const newResetBtn = resetBtn.cloneNode(true);
          resetBtn.replaceWith(newResetBtn);

          const scopeSelect = document.getElementById("exportScope");
          const newScopeSelect = scopeSelect.cloneNode(true);
          scopeSelect.replaceWith(newScopeSelect);

          const formatSelect = document.getElementById("exportFormat");
          const newFormatSelect = formatSelect.cloneNode(true);
          formatSelect.replaceWith(newFormatSelect);

          // ‚Üê NUEVO: Listeners para opciones CSV
          const delimiterSelect = document.getElementById("exportCsvDelimiter");
          const encodingSelect = document.getElementById("exportCsvEncoding");
          const quotingSelect = document.getElementById("exportCsvQuoting");

          // A√±adir listeners frescos
          document
            .getElementById("exportDataBtn")
            .addEventListener("click", () => this.exportData());
          document
            .getElementById("resetAllBtn")
            .addEventListener("click", () => this.resetAll());
          document
            .getElementById("exportScope")
            .addEventListener("change", () => this.updatePreview());

          // ‚Üê NUEVO: Listener para cambio de formato
          document
            .getElementById("exportFormat")
            .addEventListener("change", () => {
              this.updateCsvOptionsVisibility();
            });

          // ‚Üê NUEVO: Listeners para opciones CSV
          delimiterSelect.addEventListener("change", () =>
            this.updateDelimiterPreview()
          );
          encodingSelect.addEventListener("change", () =>
            this.updateDelimiterPreview()
          );
          quotingSelect.addEventListener("change", () =>
            this.updateDelimiterPreview()
          );
        },

        updateCsvOptionsVisibility() {
          const format = document.getElementById("exportFormat").value;
          const csvPanel = document.getElementById("csvOptionsPanel");

          if (format === "csv") {
            csvPanel.style.display = "block";
            this.updateDelimiterPreview();
          } else {
            csvPanel.style.display = "none";
          }
        },

        updateDelimiterPreview() {
          const previewDiv = document.getElementById("delimiterPreview");
          const delimiter = document.getElementById("exportCsvDelimiter").value;
          const quoting = document.getElementById("exportCsvQuoting").value;

          if (!State.data || State.data.length === 0) {
            previewDiv.textContent = "No hay datos para previsualizar";
            return;
          }

          // Obtener las primeras 5 columnas para la preview
          const allColumns = State.columns.filter(
            (col) => !col.startsWith("_")
          );
          const columns = allColumns.slice(0, 5);
          const sampleRow = State.data[0];

          const delimiterDisplay =
            delimiter === "\t"
              ? '<span style="color:var(--warning);">‚Üí</span>'
              : `<span style="color:var(--warning);">${delimiter}</span>`;
          const actualDelimiter = delimiter === "\t" ? "\t" : delimiter;

          const escapeForPreview = (value) => {
            let strValue =
              value === null || value === undefined ? "" : String(value);

            if (quoting === "all") {
              return `<span style="color:var(--accent);">"</span>${strValue}<span style="color:var(--accent);">"</span>`;
            } else if (quoting === "none") {
              return strValue;
            } else {
              // Minimal
              const needsQuotes =
                strValue.includes(actualDelimiter) ||
                strValue.includes('"') ||
                strValue.includes("\n") ||
                strValue.startsWith(" ") ||
                strValue.endsWith(" ");

              if (needsQuotes) {
                return `<span style="color:var(--accent);">"</span>${strValue.replace(
                  /"/g,
                  '""'
                )}<span style="color:var(--accent);">"</span>`;
              }
              return strValue;
            }
          };

          // Construir preview de header
          const headerParts = columns.map((col) => escapeForPreview(col));
          const headerPreview = headerParts.join(delimiterDisplay);

          // Construir preview de data
          const dataParts = columns.map((col) => {
            const value = sampleRow.hasOwnProperty(col) ? sampleRow[col] : "";
            return escapeForPreview(value);
          });
          const dataPreview = dataParts.join(delimiterDisplay);

          const encoding = document.getElementById("exportCsvEncoding").value;
          const encodingNote =
            encoding === "utf-8-bom"
              ? ' <span style="color:var(--warning);">(con BOM para Excel)</span>'
              : "";

          const moreColumns =
            allColumns.length > 5
              ? `${delimiterDisplay}<span style="color:var(--muted);">... (+${
                  allColumns.length - 5
                } columnas m√°s)</span>`
              : "";

          previewDiv.innerHTML = `
            <div style="margin-bottom:8px;">
              <strong style="color:var(--muted);font-size:11px;">ENCABEZADOS (${
                allColumns.length
              } columnas totales):</strong><br>
              ${headerPreview}${moreColumns}
            </div>
            <div>
              <strong style="color:var(--muted);font-size:11px;">DATOS (ejemplo de primera fila):</strong><br>
              ${dataPreview}${moreColumns}
            </div>
            <br>
            <span style="color:var(--muted);font-size:11px;">
              üìå Delimitador: <strong>${
                delimiter === "\t"
                  ? "Tabulador (‚Üí)"
                  : delimiter === ","
                  ? "Coma (,)"
                  : delimiter === ";"
                  ? "Punto y coma (;)"
                  : "Pipe (|)"
              }</strong> |
              Codificaci√≥n: <strong>${encoding}</strong>${encodingNote} |
              Entrecomillado: <strong>${
                quoting === "minimal"
                  ? "M√≠nimo"
                  : quoting === "all"
                  ? "Todos"
                  : "Ninguno"
              }</strong>
            </span>
            <br>
            <span style="color:var(--success);font-size:11px;">
              ‚úÖ Se exportar√°n <strong>${
                allColumns.length
              } columnas</strong> completas para cada fila
            </span>
          `;
        },
        render() {
          this.updateStats();
          this.updatePreview();
        },

        updateStats() {
          const filteredData = Utils.applyFilters(State.data, State.filters);
          document.getElementById("exportTotalRows").textContent =
            State.data.length;
          document.getElementById("exportModifiedRows").textContent =
            State.modifiedRowIndices.size;
          document.getElementById("exportVisibleRows").textContent =
            filteredData.length;
        },

        updatePreview() {
          const scope = document.getElementById("exportScope").value;
          let dataToShow;

          switch (scope) {
            case "visible":
              dataToShow = Utils.applyFilters(State.data, State.filters);
              break;
            case "modified":
              dataToShow = State.data.filter((row) => row._modified);
              break;
            default:
              dataToShow = State.data;
          }

          this.renderTable(dataToShow);
        },

        renderTable(data) {
          const thead = document.getElementById("exportTableHead");
          const tbody = document.getElementById("exportTableBody");
          const headers = State.columns.filter((col) => !col.startsWith("_"));

          thead.innerHTML = `<tr>${headers
            .map((col) => `<th>${col}</th>`)
            .join("")}</tr>`;

          const displayData = data.slice(0, 500);
          tbody.innerHTML = displayData
            .map(
              (row) => `
      <tr class="${row._modified ? "modified" : ""}">
        ${headers.map((col) => `<td>${row[col] || ""}</td>`).join("")}
      </tr>
    `
            )
            .join("");
        },

        exportData() {
          const format = document.getElementById("exportFormat").value;
          const scope = document.getElementById("exportScope").value;

          let dataToExport;
          switch (scope) {
            case "visible":
              dataToExport = Utils.applyFilters(State.data, State.filters);
              break;
            case "modified":
              dataToExport = State.data.filter((row) => row._modified);
              break;
            default:
              dataToExport = State.data;
          }

          if (dataToExport.length === 0) {
            alert("No hay datos para exportar con los filtros seleccionados.");
            return;
          }

          const columns = State.columns.filter((col) => !col.startsWith("_"));
          const timestamp = new Date()
            .toISOString()
            .replace(/[:.]/g, "-")
            .slice(0, -5);
          const scopeText =
            scope === "visible"
              ? "filtered"
              : scope === "modified"
              ? "modified"
              : "full";
          const filename = `data_export_${scopeText}_${timestamp}`;

          if (format === "csv") {
            // ‚Üê NUEVO: Obtener opciones CSV
            const delimiter =
              document.getElementById("exportCsvDelimiter").value;
            const encoding = document.getElementById("exportCsvEncoding").value;
            const quoting = document.getElementById("exportCsvQuoting").value;

            const csvOptions = {
              delimiter: delimiter === "\\t" ? "\t" : delimiter,
              encoding: encoding,
              quoting: quoting,
            };

            Utils.exportToCSV(
              dataToExport,
              State.columns,
              `${filename}.csv`,
              csvOptions
            );

            const delimiterName =
              delimiter === "\t"
                ? "Tabulador"
                : delimiter === ","
                ? "Coma"
                : delimiter === ";"
                ? "Punto y coma"
                : "Pipe";
            Utils.setStatus(
              "success",
              `‚úÖ ${dataToExport.length} filas exportadas (CSV con ${delimiterName})`,
              "üíæ"
            );
          } else {
            Utils.exportToExcel(
              dataToExport,
              State.columns,
              `${filename}.xlsx`
            );
            Utils.setStatus(
              "success",
              `‚úÖ ${dataToExport.length} filas exportadas (Excel)`,
              "üíæ"
            );
          }
        },

        resetAll() {
          if (
            confirm(
              "¬øEst√°s seguro de que quieres reiniciar todo? Se perder√°n todos los cambios no exportados."
            )
          ) {
            State.files = [];
            State.columns = [];
            State.data = [];
            State.originalData = [];
            State.filters = [];
            State.modifications = [];
            State.modifiedRowIndices.clear();
            State.changeLog = [];

            document.getElementById("fileInput").value = "";
            Navigation.goToStep(1);
            Utils.setStatus(
              "info",
              "Aplicaci√≥n reiniciada. Sube archivos para comenzar de nuevo",
              "üîÑ"
            );
          }
        },
      };

      // ============================================
      // INITIALIZATION
      // ============================================
      document.addEventListener("DOMContentLoaded", () => {
        FileLoader.init();
        Navigation.setupNavigation();

        Utils.setStatus(
          "info",
          "Bienvenido a Data Editor Pro. Sube tus archivos CSV o Excel para comenzar",
          "üëã"
        );
      });
    </script>
  </body>
</html>
